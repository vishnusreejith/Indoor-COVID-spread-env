<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Risk App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background from risk app */
        }
        /* Custom style for number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        input[type='text'] {
            -moz-appearance: textfield;
        }
        
        /* Helper class to hide/show pages */
        .hidden-page {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- 
      PAGE 1: CO2 ESTIMATOR 
      (Adapted from Co2 estimation.html)
    -->
    <div id="co2EstimatorPage" class="max-w-md w-full">
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 text-center mb-4">
                Step 1: Indoor CO₂ Estimator
            </h1>
            <p class="text-gray-600 text-center mb-6">
                Calculate steady-state indoor CO₂ concentration.
            </p>

            <!-- CO2 Input Form -->
            <form id="co2Form" class="space-y-4">
                
                <!-- Outdoor CO2 -->
                <div>
                    <label for="cOutdoor" class="block text-sm font-medium text-gray-700 mb-1">
                        Outdoor CO₂ Concentration (C<sub>outdoor</sub>)
                    </label>
                    <div class="relative">
                        <input type="text" inputmode="decimal" id="cOutdoor" value="420" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 420">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ppm</span>
                    </div>
                </div>

                <!-- Number of Occupants -->
                <div>
                    <label for="occupants" class="block text-sm font-medium text-gray-700 mb-1">
                        Number of Occupants (n)
                    </label>
                    <input type="text" inputmode="numeric" id="occupants" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 10">
                </div>

                <!-- CO2 Generation Rate -->
                <div>
                    <label for="co2Rate" class="block text-sm font-medium text-gray-700 mb-1">
                        CO₂ Generation per Person (r)
                    </label>
                    <select id="co2Rate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="0.005" selected>Sedentary (office, classroom) - 0.005 L/s</option>
                        <option value="0.007">Light Activity (retail, walking) - 0.007 L/s</option>
                        <option value="0.011">Moderate Activity (gym, dancing) - 0.011 L/s</option>
                        <option value="0.018">Heavy Activity (athletics) - 0.018 L/s</option>
                    </select>
                </div>

                <!-- Room Dimensions Section -->
                <div class="space-y-2 pt-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Room Dimensions</label>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label for="roomLength" class="block text-xs font-medium text-gray-700 mb-1">Length (m)</label>
                            <input type="text" inputmode="decimal" id="roomLength" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 5">
                        </div>
                        <div>
                            <label for="roomWidth" class="block text-xs font-medium text-gray-700 mb-1">Width (m)</label>
                            <input type="text" inputmode="decimal" id="roomWidth" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 4">
                        </div>
                        <div>
                            <label for="roomHeight" class="block text-xs font-medium text-gray-700 mb-1">Height (m)</label>
                            <input type="text" inputmode="decimal" id="roomHeight" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 2.5">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Required for "Estimate (ACH)" mode. Optional for other modes to show resulting ACH.</p>
                </div>

                <!-- Ventilation Rate Section -->
                <div class="space-y-3 pt-2">
                    <div>
                        <label for="vaModeSelect" class="block text-sm font-medium text-gray-700 mb-1">Ventilation Rate (V<sub>a</sub>) Mode</label>
                        <select id="vaModeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="direct" selected>Enter V_a (L/s) Directly</option>
                            <option value="estimate">Estimate from Room (ACH)</option>
                            <option value="cfm">Calculate from Fan (CFM)</option>
                            <option value="naturalCross">Natural Vent. (Cross-Ventilation)</option>
                            <option value="naturalSingle">Natural Vent. (Single-Side)</option>
                            <option value="mechanical">Mechanical Vent. (Area/Velocity)</option>
                        </select>
                    </div>

                    <!-- Direct Input Group -->
                    <div id="directVaGroup">
                        <div class="relative">
                            <input type="text" inputmode="decimal" id="ventilation" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 100">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">L/s</span>
                        </div>
                    </div>

                    <!-- Estimation (ACH) Input Group -->
                    <div id="estimateVaGroup" class="hidden space-y-3 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <p class="text-xs text-gray-600">Calculates V<sub>a</sub> from Room Volume and Air Changes per Hour (ACH).</p>
                        <div>
                            <label for="roomType" class="block text-xs font-medium text-gray-700 mb-1">Room Type (Selects typical ACH)</label>
                            <select id="roomType" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="0.3">Modern, Sealed Home</option>
                                <option value="0.5" selected>Standard Home</option>
                                <option value="1.0">Older, Leaky Home</option>
                                <option value="3.0">Office / Retail Store</option>
                                <option value="6.0">Classroom / Conference Room</option>
                                <option value="8.0">Gym / High-Activity Area</option>
                            </select>
                        </div>
                        <div id="estimatedVaResult" class="text-sm text-center font-medium text-blue-700 hidden"></div>
                    </div>

                    <!-- CFM Input Group -->
                    <div id="cfmVaGroup" class="hidden space-y-3 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <p class="text-xs text-gray-600">Calculates V<sub>a</sub> from a fan or HVAC fresh air supply rating.</p>
                        <div>
                            <label for="fanCFM" class="block text-xs font-medium text-gray-700 mb-1">Fresh Air Supply (CFM)</label>
                            <div class="relative">
                                <input type="text" inputmode="decimal" id="fanCFM" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 150">
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">CFM</span>
                            </div>
                        </div>
                        <div id="cfmVaResult" class="text-sm text-center font-medium text-blue-700 hidden"></div>
                    </div>

                    <!-- Natural Cross-Side -->
                    <div id="naturalCrossVaGroup" class="hidden space-y-3 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <p class="text-xs text-gray-600"><b>Cross Ventilation</b> (e.g., open window + door):<br><code>Vₐ = 0.65 * wind * area * 1000</code></p>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="natCrossWind" class="block text-xs font-medium text-gray-700 mb-1">Wind Speed (m/s)</label>
                                <input type="text" inputmode="decimal" id="natCrossWind" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 2">
                            </div>
                            <div>
                                <label for="natCrossArea" class="block text-xs font-medium text-gray-700 mb-1">Smallest Area (m²)</label>
                                <input type="text" inputmode="decimal" id="natCrossArea" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 1.5">
                            </div>
                        </div>
                        <div id="naturalCrossVaResult" class="text-sm text-center font-medium text-blue-700 hidden"></div>
                    </div>

                    <!-- Natural Single-Side -->
                    <div id="naturalSingleVaGroup" class="hidden space-y-3 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <p class="text-xs text-gray-600"><b>Single-Side Ventilation</b> (e.g., open window only):<br><code>Vₐ = 0.05 * wind * area * 1000</code></p>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="natSingleWind" class="block text-xs font-medium text-gray-700 mb-1">Wind Speed (m/s)</label>
                                <input type="text" inputmode="decimal" id="natSingleWind" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 2">
                            </div>
                            <div>
                                <label for="natSingleArea" class="block text-xs font-medium text-gray-700 mb-1">Opening Area (m²)</label>
                                <input type="text" inputmode="decimal" id="natSingleArea" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 1.5">
                            </div>
                        </div>
                        <div id="naturalSingleVaResult" class="text-sm text-center font-medium text-blue-700 hidden"></div>
                    </div>

                    <!-- Mechanical -->
                    <div id="mechanicalVaGroup" class="hidden space-y-3 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <p class="text-xs text-gray-600">Calculates V<sub>a</sub> from air velocity at vent: <br><code>Vₐ = velocity * area * 1000</code></p>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="mechVelocity" class="block text-xs font-medium text-gray-700 mb-1">Air Velocity (m/s)</label>
                                <input type="text" inputmode="decimal" id="mechVelocity" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 0.5">
                            </div>
                            <div>
                                <label for="mechArea" class="block text-xs font-medium text-gray-700 mb-1">Total Vent Area (m²)</label>
                                <input type="text" inputmode="decimal" id="mechArea" class="w-full px-2 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., 0.2">
                            </div>
                        </div>
                        <div id="mechanicalVaResult" class="text-sm text-center font-medium text-blue-700 hidden"></div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-md shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    Calculate CO₂
                </button>
            </form>

            <!-- CO2 Result Display -->
            <div id="co2-result-container" class="mt-6 hidden">
                <div id="co2-result-card" class="rounded-md p-6">
                    <h3 class="text-sm font-medium text-center mb-2" id="co2-result-label">Estimated Indoor CO₂ Level</h3>
                    <p class="text-4xl md:text-5xl font-bold text-center" id="co2-result-value">
                        <!-- Result will be injected here -->
                    </p>
                    <p class="text-center text-sm" id="co2-result-unit">ppm</p>
                    <p class="text-center text-xs text-gray-500 mt-2" id="co2-result-va-info"></p>
                    
                    <!-- Button to proceed -->
                    <button id="goToRiskBtn" class="w-full mt-4 bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                        Use this value for Risk Calculation
                    </button>
                </div>
                <!-- Error Message -->
                <div id="co2-error-message" class="hidden mt-4 text-center text-red-600 font-medium"></div>
            </div>

            <!-- Manual Entry Section -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <p class="text-center text-gray-600 mb-4 font-medium">
                    --- OR ---
                </p>
                <p class="text-center text-gray-600 mb-4">
                    If you already know your CO₂ level:
                </p>
                <div class="space-y-3">
                    <div>
                        <label for="manualCo2Input" class="block text-sm font-medium text-gray-700 mb-1">
                            Enter CO₂ (ppm)
                        </label>
                        <input type="text" inputmode="numeric" id="manualCo2Input" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 850">
                    </div>
                    <button id="goToRiskManualBtn" class="w-full bg-gray-600 text-white font-semibold py-2 px-4 rounded-md shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                        Go to Risk Calculation
                    </button>
                    <p id="manual-co2-error" class="text-red-600 text-sm text-center hidden"></p>
                </div>
            </div>

            <!-- Info Button -->
            <div class="text-center mt-6">
                <button type="button" id="goToInfoBtn" class="text-sm text-blue-600 hover:underline">
                    Why does CO₂ level matter for risk?
                </button>
            </div>
        </div>
    </div>

    <!-- 
      PAGE 2: COVID RISK ESTIMATOR 
      (Adapted from index.html, PM inputs removed)
    -->
    <div id="covidRiskPage" class="max-w-md w-full hidden-page">
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700">
            <h1 class="text-3xl font-bold text-center text-blue-400 mb-2">
                Step 2: COVID-19 Risk
            </h1>
            <p class="text-center text-gray-400 text-sm mb-6">
                Based on T, H, and CO₂ threshold rules.
            </p>

            <!-- Risk Input Form -->
            <form id="risk-form" class="space-y-4">
                <!-- Temperature -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="temperature" class="block text-sm font-medium text-gray-300">
                            Temperature (°C)
                        </label>
                        <!-- NEW Weather Button -->
                        <button type="button" id="getWeatherBtn" class="text-xs text-blue-400 hover:text-blue-300 transition-colors">
                            Get Local Weather
                        </button>
                    </div>
                    <input type="text" inputmode="decimal" id="temperature" name="temperature" placeholder="e.g., 22.5" class="w-full p-3 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>

                <!-- Humidity -->
                <div>
                    <label for="humidity" class="block text-sm font-medium text-gray-300 mb-1">
                        Humidity (%)
                    </label>
                    <input type="text" inputmode="decimal" id="humidity" name="humidity" placeholder="e.g., 55" class="w-full p-3 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <!-- NEW Weather Status Message -->
                <p id="weather-status" class="text-xs text-center text-gray-400 hidden-page"></p>

                <!-- CO2 -->
                <div>
                    <label for="co2" class="block text-sm font-medium text-gray-300 mb-1">
                        CO₂ Concentration (ppm)
                    </label>
                    <input type="text" inputmode="numeric" id="co2" name="co2" placeholder="e.g., 800" class="w-full p-3 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <!-- PM fields are permanently removed as requested -->

                <!-- Error Message -->
                <p id="risk-error-message" class="text-red-400 text-sm text-center hidden"></p>

                <!-- Submit Button -->
                <button type="submit" class="w-full p-3 rounded-md bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors duration-200 shadow-lg">
                    Calculate Risk
                </button>
            </form>

            <!-- Risk Result Display -->
            <div id="risk-results-container" class="mt-8 pt-6 border-t border-gray-700 space-y-6 hidden">
                <!-- Threshold Risk (Fig 3) -->
                <div id="threshold-risk-result" class="p-4 rounded-lg border">
                    <h3 id="threshold-risk-level" class="text-xl font-bold"></h3>
                    <p id="threshold-risk-recommendation" class="mt-1 text-sm"></p>
                    <p class="text-xs text-gray-300 opacity-80 mt-2">
                        (Based on T, H, and CO₂ threshold rules)
                    </p>
                </div>
                <!-- PM Risk result is removed -->
            </div>

             <!-- Navigation Button -->
             <button id="goToCo2Btn" class="w-full mt-6 text-sm text-gray-400 hover:text-white transition-colors">
                &larr; Back to CO₂ Estimator
             </button>

             <!-- Info Button -->
             <button type="button" id="goToInfoBtn_risk" class="w-full mt-4 text-sm text-blue-400 hover:text-white transition-colors">
                Why does CO₂ matter? (Info)
            </button>
        </div>
    </div>

    <!-- 
      PAGE 3: INFO PAGE
      (New Content)
    -->
    <div id="infoPage" class="max-w-md w-full hidden-page">
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700 text-gray-300">
            <h1 class="text-2xl font-bold text-center text-blue-400 mb-6">
                CO₂ as a Risk Proxy
            </h1>
            
            <div class="space-y-4 text-sm">
                <p>This app uses CO₂ as an *indicator* for potential aerosol infection risk. Here’s why:</p>
                
                <h2 class="text-lg font-semibold text-white mt-4">The Source</h2>
                <p>When people breathe, they exhale both <strong>Carbon Dioxide (CO₂)</strong> and tiny airborne particles called <strong>aerosols</strong>. If an person is sick with an airborne illness (like COVID-19 or the flu), their aerosols will be contaminated with the virus.</p>
                
                <h2 class="text-lg font-semibold text-white mt-4">The Buildup</h2>
                <p>In a poorly ventilated indoor space, both CO₂ and infectious aerosols build up in the air over time. Every new breath adds more.</p>
                
                <h2 class="text-lg font-semibold text-white mt-4">The Connection</h2>
                <p>A high CO₂ level means there is a high amount of <strong>rebreathed air</strong> in the room. This strongly implies that if an infected person is present, the concentration of infectious aerosols is *also* high, increasing the risk for everyone else.</p>
                
                <h2 class="text-lg font-semibold text-white mt-4">Important Notes:</h2>
                <ul class="list-disc list-inside space-y-1 pl-2">
                    <li>CO₂ is a <strong>proxy</strong>, not a direct measurement of viruses.</li>
                    <li><strong>Air purifiers (HEPA filters)</strong> can remove infectious aerosols, but they do <strong>not</strong> remove CO₂. In this case, CO₂ would be high but risk might be lower.</li>
                    <li><strong>Masks</strong> reduce the amount of aerosols (and viruses) released, but they do not stop CO₂.</li>
                </ul>
                
                <p class="font-semibold text-white">The best action is to bring in fresh outdoor air (ventilation), which dilutes and removes *both* CO₂ and infectious aerosols at the same time.</p>
            </div>

            <!-- Back Button -->
            <button id="backBtn_info" class="w-full mt-8 p-3 rounded-md bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors duration-200 shadow-lg">
                Back to App
            </button>
        </div>
    </div>


    <!-- --- COMBINED JAVASCRIPT LOGIC --- -->
    <script>
        // --- Page Navigation & Data Transfer ---
        let co2ValueToTransfer = null; // Use a variable, not localStorage
        let lastActivePage = 'co2'; // 'co2' or 'risk'
        
        const co2Page = document.getElementById('co2EstimatorPage');
        const riskPage = document.getElementById('covidRiskPage');
        const infoPage = document.getElementById('infoPage'); // NEW
        
        const goToRiskBtn = document.getElementById('goToRiskBtn');
        const goToCo2Btn = document.getElementById('goToCo2Btn');
        
        // NEW Info Buttons
        const goToInfoBtn = document.getElementById('goToInfoBtn');
        const goToInfoBtn_risk = document.getElementById('goToInfoBtn_risk');
        const backBtn_info = document.getElementById('backBtn_info');

        function showRiskPage() {
            if (co2ValueToTransfer) {
                document.getElementById('co2').value = co2ValueToTransfer;
            }
            co2ValueToTransfer = null;
            
            co2Page.classList.add('hidden-page');
            riskPage.classList.remove('hidden-page');
            infoPage.classList.add('hidden-page'); // HIDE INFO
            lastActivePage = 'risk'; // SET LAST
        }

        function showCo2Page() {
            riskPage.classList.add('hidden-page');
            infoPage.classList.add('hidden-page'); // HIDE INFO
            co2Page.classList.remove('hidden-page');
            lastActivePage = 'co2'; // SET LAST
        }

        // NEW Info Page Function
        function showInfoPage() {
            riskPage.classList.add('hidden-page');
            co2Page.classList.add('hidden-page'); // HIDE CO2
            infoPage.classList.remove('hidden-page'); // SHOW INFO
        }
        
        // NEW Back from Info Function
        function goBackFromInfo() {
            infoPage.classList.add('hidden-page'); // HIDE INFO
            if (lastActivePage === 'risk') {
                riskPage.classList.remove('hidden-page');
            } else {
                co2Page.classList.remove('hidden-page'); // Default to CO2 page
            }
        }

        // Attach navigation events
        goToRiskBtn.addEventListener('click', showRiskPage);
        goToCo2Btn.addEventListener('click', showCo2Page);
        
        // NEW Listeners
        goToInfoBtn.addEventListener('click', showInfoPage);
        goToInfoBtn_risk.addEventListener('click', showInfoPage);
        backBtn_info.addEventListener('click', goBackFromInfo);

        // --- Start of CO2 Estimator JS (from Co2_estimation_corrected.html) ---
        (function() {
            // --- Constants ---
            const CFM_TO_LPS = 0.471947; // 1 CFM ≈ 0.4719 L/s
            const NATURAL_CROSS_COEFF = 0.65; 
            const NATURAL_SINGLE_COEFF = 0.05;

            // --- Helper: Sanitize input for parseFloat ---
            function getFloat(id) {
                const element = document.getElementById(id);
                if (!element) return NaN;
                
                const value = element.value.trim().replace(',', '.');
                
                if (value === "") return NaN; 
                
                const isValidNumber = /^-?(\d+(\.\d*)?|\.\d+)$/.test(value);
                
                if (isValidNumber) {
                    return parseFloat(value);
                } else {
                    return NaN;
                }
            }

            // --- Get Elements ---
            const vaModeSelect = document.getElementById('vaModeSelect');
            const directVaGroup = document.getElementById('directVaGroup');
            const estimateVaGroup = document.getElementById('estimateVaGroup');
            const cfmVaGroup = document.getElementById('cfmVaGroup');
            const naturalSingleVaGroup = document.getElementById('naturalSingleVaGroup');
            const naturalCrossVaGroup = document.getElementById('naturalCrossVaGroup');
            const mechanicalVaGroup = document.getElementById('mechanicalVaGroup');

            const estimatedVaResult = document.getElementById('estimatedVaResult');
            const cfmVaResult = document.getElementById('cfmVaResult');
            const fanCFMInput = document.getElementById('fanCFM');
            const naturalSingleVaResult = document.getElementById('naturalSingleVaResult');
            const naturalCrossVaResult = document.getElementById('naturalCrossVaResult');
            const mechanicalVaResult = document.getElementById('mechanicalVaResult');

            // --- Mode Toggle Event Listener ---
            vaModeSelect.addEventListener('change', (e) => {
                const mode = e.target.value;
                directVaGroup.classList.toggle('hidden', mode !== 'direct');
                estimateVaGroup.classList.toggle('hidden', mode !== 'estimate');
                cfmVaGroup.classList.toggle('hidden', mode !== 'cfm');
                naturalSingleVaGroup.classList.toggle('hidden', mode !== 'naturalSingle');
                naturalCrossVaGroup.classList.toggle('hidden', mode !== 'naturalCross');
                mechanicalVaGroup.classList.toggle('hidden', mode !== 'mechanical');

                if (mode === 'estimate') {
                    updateEstimatedVa();
                }
            });

            // --- Helper Functions for Va Calculation ---
            function checkAndUpdateEstimatedVa() {
                if (vaModeSelect.value === 'estimate') {
                    updateEstimatedVa();
                }
            }

            // --- ACH Estimation ---
            function updateEstimatedVa() {
                const length = getFloat('roomLength');
                const width = getFloat('roomWidth');
                const height = getFloat('roomHeight');
                const ach = getFloat('roomType');

                if (isNaN(length) || isNaN(width) || isNaN(height) || length <= 0 || width <= 0 || height <= 0) {
                    estimatedVaResult.textContent = 'Please enter valid room dimensions above.';
                    estimatedVaResult.classList.remove('hidden', 'text-blue-700');
                    estimatedVaResult.classList.add('text-red-600');
                    return NaN;
                }
                
                estimatedVaResult.classList.remove('text-red-600');
                estimatedVaResult.classList.add('text-blue-700');

                if (!isNaN(ach)) {
                    const volume = length * width * height; // m³
                    const vA = (ach * volume) / 3.6;
                    estimatedVaResult.textContent = `Estimated Vₐ: ${vA.toFixed(2)} L/s`;
                    estimatedVaResult.classList.remove('hidden');
                    return vA;
                }
                estimatedVaResult.classList.add('hidden');
                return NaN;
            }
            document.getElementById('roomLength').addEventListener('input', checkAndUpdateEstimatedVa);
            document.getElementById('roomWidth').addEventListener('input', checkAndUpdateEstimatedVa);
            document.getElementById('roomHeight').addEventListener('input', checkAndUpdateEstimatedVa);
            document.getElementById('roomType').addEventListener('change', checkAndUpdateEstimatedVa);

            // --- CFM Calculation ---
            function updateCFMVa() {
                const cfm = getFloat('fanCFM');
                if (!isNaN(cfm)) {
                    const vA = cfm * CFM_TO_LPS;
                    cfmVaResult.textContent = `Calculated Vₐ: ${vA.toFixed(2)} L/s`;
                    cfmVaResult.classList.remove('hidden');
                    return vA;
                }
                cfmVaResult.classList.add('hidden');
                return NaN;
            }
            fanCFMInput.addEventListener('input', updateCFMVa);

            // --- Natural Single-Side ---
            function updateNaturalSingleVa() {
                const wind = getFloat('natSingleWind');
                const area = getFloat('natSingleArea');
                if (!isNaN(wind) && !isNaN(area)) {
                    const vA = NATURAL_SINGLE_COEFF * wind * area * 1000;
                    naturalSingleVaResult.textContent = `Calculated Vₐ: ${vA.toFixed(2)} L/s`;
                    naturalSingleVaResult.classList.remove('hidden');
                    return vA;
                }
                naturalSingleVaResult.classList.add('hidden');
                return NaN;
            }
            document.getElementById('natSingleWind').addEventListener('input', updateNaturalSingleVa);
            document.getElementById('natSingleArea').addEventListener('input', updateNaturalSingleVa);

            // --- Natural Cross-Side ---
            function updateNaturalCrossVa() {
                const wind = getFloat('natCrossWind');
                const area = getFloat('natCrossArea');
                if (!isNaN(wind) && !isNaN(area)) {
                    const vA = NATURAL_CROSS_COEFF * wind * area * 1000;
                    naturalCrossVaResult.textContent = `Calculated Vₐ: ${vA.toFixed(2)} L/s`;
                    naturalCrossVaResult.classList.remove('hidden');
                    return vA;
                }
                naturalCrossVaResult.classList.add('hidden');
                return NaN;
            }
            document.getElementById('natCrossWind').addEventListener('input', updateNaturalCrossVa);
            document.getElementById('natCrossArea').addEventListener('input', updateNaturalCrossVa);

            // --- Mechanical ---
            function updateMechanicalVa() {
                const velocity = getFloat('mechVelocity');
                const area = getFloat('mechArea');
                if (!isNaN(velocity) && !isNaN(area)) {
                    const vA = velocity * area * 1000;
                    mechanicalVaResult.textContent = `Calculated Vₐ: ${vA.toFixed(2)} L/s`;
                    mechanicalVaResult.classList.remove('hidden');
                    return vA;
                }
                mechanicalVaResult.classList.add('hidden');
                return NaN;
            }
            document.getElementById('mechVelocity').addEventListener('input', updateMechanicalVa);
            document.getElementById('mechArea').addEventListener('input', updateMechanicalVa);

            // --- Main Form Submission ---
            document.getElementById('co2Form').addEventListener('submit', function(event) {
                event.preventDefault(); 

                const resultContainer = document.getElementById('co2-result-container');
                const resultCard = document.getElementById('co2-result-card');
                const resultValue = document.getElementById('co2-result-value');
                const resultLabel = document.getElementById('co2-result-label');
                const resultVaInfo = document.getElementById('co2-result-va-info');
                const errorMessage = document.getElementById('co2-error-message');
                
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
                resultVaInfo.textContent = '';

                // --- Get Ventilation Rate (Va) ---
                let vA;
                let vaSourceInfo = '';
                const selectedMode = vaModeSelect.value;

                switch (selectedMode) {
                    case 'direct':
                        vA = getFloat('ventilation');
                        if (!isNaN(vA)) vaSourceInfo = `(using Vₐ = ${vA.toFixed(2)} L/s)`;
                        break;
                    case 'estimate':
                        vA = updateEstimatedVa();
                        if (!isNaN(vA)) vaSourceInfo = `(using estimated Vₐ = ${vA.toFixed(2)} L/s)`;
                        break;
                    case 'cfm':
                        vA = updateCFMVa();
                        if (!isNaN(vA)) {
                            const cfm = getFloat('fanCFM');
                            vaSourceInfo = `(using ${cfm} CFM ≈ ${vA.toFixed(2)} L/s)`;
                        }
                        break;
                    case 'naturalSingle':
                        vA = updateNaturalSingleVa();
                        if (!isNaN(vA)) vaSourceInfo = `(Nat. Single: ${vA.toFixed(2)} L/s)`;
                        break;
                    case 'naturalCross':
                        vA = updateNaturalCrossVa();
                        if (!isNaN(vA)) vaSourceInfo = `(Nat. Cross: ${vA.toFixed(2)} L/s)`;
                        break;
                    case 'mechanical':
                        vA = updateMechanicalVa();
                        if (!isNaN(vA)) vaSourceInfo = `(Mech. Vent: ${vA.toFixed(2)} L/s)`;
                    break;
                }

                // --- Get other values ---
                const cOutdoor = getFloat('cOutdoor');
                const r = getFloat('co2Rate');
                const n = getFloat('occupants');

                // --- Validate inputs ---
                if (isNaN(cOutdoor) || isNaN(r) || isNaN(n)) {
                    errorMessage.textContent = 'Please enter valid numbers for CO₂, Occupants, and Rate.';
                    errorMessage.classList.remove('hidden');
                    resultContainer.classList.add('hidden');
                    return;
                }

                if (isNaN(vA)) {
                    errorMessage.textContent = 'Please enter valid numbers in the selected Vₐ section to calculate a ventilation rate.';
                    errorMessage.classList.remove('hidden');
                    resultContainer.classList.add('hidden');
                    return;
                }

                if (vA <= 0) {
                    errorMessage.textContent = 'Ventilation Rate (Va) must be greater than zero.';
                    errorMessage.classList.remove('hidden');
                    resultContainer.classList.add('hidden');
                    return;
                }

                // --- Perform the calculation ---
                const addedCO2_fraction = (r * n) / vA;
                const addedCO2_ppm = addedCO2_fraction * 1_000_000;
                const cIndoor = cOutdoor + addedCO2_ppm;
                const cIndoorRounded = cIndoor.toFixed(0);

                // --- Store value in our variable ---
                co2ValueToTransfer = cIndoorRounded;

                // --- Display the result ---
                resultValue.textContent = cIndoorRounded;
                
                let achInfo = '';
                const length = getFloat('roomLength');
                const width = getFloat('roomWidth');
                const height = getFloat('roomHeight');
                if (!isNaN(length) && !isNaN(width) && !isNaN(height) && length > 0 && width > 0 && height > 0) {
                    const volume = length * width * height;
                    if (volume > 0 && !isNaN(vA)) {
                        const ach = (vA * 3.6) / volume;
                        achInfo = ` | ${ach.toFixed(1)} ACH`;
                    }
                }
                resultVaInfo.textContent = vaSourceInfo + achInfo;
                
                // Update result card color
                resultCard.classList.remove('bg-green-100', 'text-green-900', 'bg-yellow-100', 'text-yellow-900', 'bg-red-100', 'text-red-900');
                let labelText = 'Estimated Indoor CO₂ Level';
                let labelColor = 'text-gray-700';

                if (cIndoor < 1000) {
                    resultCard.classList.add('bg-green-100', 'text-green-900');
                    labelColor = 'text-green-700';
                    labelText = 'Good Indoor Air Quality';
                } else if (cIndoor <= 2000) {
                    resultCard.classList.add('bg-yellow-100', 'text-yellow-900');
                    labelColor = 'text-yellow-700';
                    labelText = 'Moderate Indoor Air Quality';
                } else {
                    resultCard.classList.add('bg-red-100', 'text-red-900');
                    labelColor = 'text-red-700';
                    labelText = 'Poor Indoor Air Quality';
                }
                
                resultLabel.textContent = labelText;
                resultLabel.className = `text-sm font-medium text-center mb-2 ${labelColor}`;

                resultContainer.classList.remove('hidden');
            });

            // --- Manual CO2 Submission ---
            const goToRiskManualBtn = document.getElementById('goToRiskManualBtn');
            const manualCo2Input = document.getElementById('manualCo2Input');
            const manualCo2Error = document.getElementById('manual-co2-error');

            goToRiskManualBtn.addEventListener('click', function() {
                // Use the *same* getFloat helper
                const co2Val = getFloat('manualCo2Input'); 
                
                if (isNaN(co2Val) || co2Val <= 0) {
                    manualCo2Error.textContent = 'Please enter a valid CO₂ value (e.g., 850).';
                    manualCo2Error.classList.remove('hidden');
                } else {
                    manualCo2Error.classList.add('hidden');
                    // Store the manually entered value in our variable
                    co2ValueToTransfer = co2Val.toFixed(0);
                    
                    // Go to the risk page
                    showRiskPage(); 
                }
            });

        })();
        // --- End of CO2 Estimator JS ---


        // --- Start of COVID Risk JS (from index.html, modified) ---
        (function() {
             // --- Helper Function: Risk Calculation Logic (Figure 3) ---
            const calculateRisk = (temp, humidity, co2) => {
                if (co2 > 1000) {
                return {
                    level: 'High',
                    color: 'bg-red-600',
                    textColor: 'text-red-100',
                    borderColor: 'border-red-500',
                    recommendation:
                    'High CO₂ detected. Immediate ventilation is strongly recommended.',
                };
                }
                if ((temp > 24 && co2 <= 700) || (humidity < 50 && co2 <= 700)) {
                return {
                    level: 'Low',
                    color: 'bg-green-600',
                    textColor: 'text-green-100',
                    borderColor: 'border-green-500',
                    recommendation: 'Conditions are favorable. Maintain good practices.',
                };
                }
                return {
                level: 'Medium',
                color: 'bg-yellow-500',
                textColor: 'text-yellow-100',
                borderColor: 'border-yellow-400',
                recommendation:
                    'Monitor conditions. Consider increasing ventilation or reducing occupancy.',
                };
            };
            
            // --- All possible color classes to remove ---
            const allColorClasses = [
                'bg-red-600', 'text-red-100', 'border-red-500',
                'bg-green-600', 'text-green-100', 'border-green-500',
                'bg-yellow-500', 'text-yellow-100', 'border-yellow-400'
            ];
            
            // Helper to get float from text input
            const getRiskFloat = (el) => {
                    if (!el) return NaN;
                    const value = el.value.trim().replace(',', '.');
                    if (value === "") return NaN;
                    const isValidNumber = /^-?(\d+(\.\d*)?|\.\d+)$/.test(value);
                    return isValidNumber ? parseFloat(value) : NaN;
            }

            // --- Get all DOM elements ---
            const form = document.getElementById('risk-form');
            const inputs = {
                temperature: document.getElementById('temperature'),
                humidity: document.getElementById('humidity'),
                co2: document.getElementById('co2'),
            };
            const errorMessage = document.getElementById('risk-error-message');
            const resultsContainer = document.getElementById('risk-results-container');
            
            const thresholdRiskResultEl = document.getElementById('threshold-risk-result');
            const thresholdRiskLevelEl = document.getElementById('threshold-risk-level');
            const thresholdRiskRecommendationEl = document.getElementById('threshold-risk-recommendation');

            // --- Handle form submission ---
            form.addEventListener('submit', (e) => {
                e.preventDefault(); 
                
                errorMessage.textContent = '';
                errorMessage.classList.add('hidden'); // Hide error
                resultsContainer.classList.add('hidden'); // Hide old results

                // --- Get and parse values ---
                const temp = getRiskFloat(inputs.temperature);
                const hum = getRiskFloat(inputs.humidity);
                const co2Val = getRiskFloat(inputs.co2);

                // --- Input Validation ---
                if (isNaN(temp) || isNaN(hum) || isNaN(co2Val)) {
                    errorMessage.textContent = 'Please fill in all fields with valid numbers.';
                    errorMessage.classList.remove('hidden'); // Show error
                    return;
                }
                if (hum < 0 || hum > 100) {
                    errorMessage.textContent = 'Humidity must be between 0 and 100.';
                    errorMessage.classList.remove('hidden'); // Show error
                    return;
                }
                if (co2Val < 0) {
                    errorMessage.textContent = 'CO2 value cannot be negative.';
                    errorMessage.classList.remove('hidden'); // Show error
                    return;
                }

                // --- All data is valid, run calculations ---
                const riskResult = calculateRisk(temp, hum, co2Val);

                // --- Update Threshold Risk Card ---
                thresholdRiskLevelEl.textContent = `${riskResult.level} Threshold Risk`;
                thresholdRiskRecommendationEl.textContent = riskResult.recommendation;
                thresholdRiskResultEl.classList.remove(...allColorClasses);
                thresholdRiskResultEl.classList.add(riskResult.color, riskResult.textColor, riskResult.borderColor);

                // Show the results
                resultsContainer.classList.remove('hidden');
            });
            
            // --- NEW: Weather Fetch Logic ---
            const getWeatherBtn = document.getElementById('getWeatherBtn');
            const weatherStatus = document.getElementById('weather-status');
            
            getWeatherBtn.addEventListener('click', () => {
                if (!navigator.geolocation) {
                    weatherStatus.textContent = 'Geolocation is not supported by your browser.';
                    weatherStatus.classList.remove('hidden-page');
                    weatherStatus.classList.add('text-red-400');
                    return;
                }

                // Reset state
                getWeatherBtn.disabled = true;
                getWeatherBtn.textContent = 'Fetching...';
                weatherStatus.classList.add('hidden-page');
                weatherStatus.classList.remove('text-red-400');
                
                const successCallback = async (position) => {
                    try {
                        const { latitude, longitude } = position.coords;
                        // Use the Open-Meteo API (no key required)
                        const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m`;
                        
                        const response = await fetch(apiUrl);
                        if (!response.ok) {
                            throw new Error('Weather API request failed.');
                        }
                        const data = await response.json();
                        
                        const temp = data.current.temperature_2m;
                        const hum = data.current.relative_humidity_2m;
                        
                        // Populate the fields
                        inputs.temperature.value = temp;
                        inputs.humidity.value = hum;
                        
                        weatherStatus.textContent = 'Local weather data populated.';
                        weatherStatus.classList.remove('hidden-page');

                    } catch (error) {
                        weatherStatus.textContent = 'Error fetching weather. Please enter manually.';
                        weatherStatus.classList.remove('hidden-page');
                        weatherStatus.classList.add('text-red-400');
                    } finally {
                        getWeatherBtn.disabled = false;
                        getWeatherBtn.textContent = 'Get Local Weather';
                    }
                };

                const errorCallback = (error) => {
                    let message = 'Could not get location. Please enter manually.';
                    if (error.code === error.PERMISSION_DENIED) {
                        message = 'You denied location permission. Please enter manually.';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        message = 'Location information is unavailable.';
                    } else if (error.code === error.TIMEOUT) {
                        message = 'Location request timed out.';
                    }
                    weatherStatus.textContent = message;
                    weatherStatus.classList.remove('hidden-page');
                    weatherStatus.classList.add('text-red-400');
                    getWeatherBtn.disabled = false;
                    getWeatherBtn.textContent = 'Get Local Weather';
                };

                navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
            });
            // --- End of NEW Weather Logic ---

        })();
        // --- End of COVID Risk JS ---
    </script>
</body>
</html>
